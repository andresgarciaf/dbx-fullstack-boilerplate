---
description: Python backend guidelines for FastAPI with modern typing
globs:
  - "src/api/**/*.py"
  - "**/*.py"
alwaysApply: false
---

# Python Backend Guidelines

## Modern Type Hints (Python 3.10+)

- Use lowercase built-in types: `list`, `dict`, `tuple`, `set`
- Use `|` for unions: `str | None` NOT `Optional[str]`
- Use `X | Y` NOT `Union[X, Y]`
- NEVER import: `Dict`, `List`, `Optional`, `Union`, `Tuple`, `Set` from typing

## Import Structure

```python
from __future__ import annotations

# Standard library
import os
import logging
from typing import TYPE_CHECKING, Any, TypeVar
from collections.abc import Iterator, Callable

# Third-party
import psycopg
from fastapi import FastAPI, APIRouter
from pydantic import BaseModel

# Local
from core import settings
from clients import SqlBackend

# Type checking only (avoid circular imports)
if TYPE_CHECKING:
    from databricks.sdk import WorkspaceClient
```

## Code Patterns

- Use `@cached_property` for lazy-loaded expensive objects
- Use dataclasses or Pydantic models for data structures
- Use descriptors for configuration attributes
- Prefer explicit error handling over bare except
- Use logging module, never print()
- Add `from __future__ import annotations` to all files

## FastAPI Patterns

- Use dependency injection for services
- Define response models with Pydantic
- Use proper HTTP status codes
- Handle errors with HTTPException