services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ..:/workspace:cached,z
      # Persist VS Code extensions and server
      - vscode-extensions:/home/vscode/.vscode-server/extensions:z
      - vscode-insiders:/home/vscode/.vscode-server-insiders/extensions:z
      # Persist pnpm cache for faster installs
      - pnpm-store:/home/vscode/.local/share/pnpm:z
      # Persist uv cache for faster Python installs
      - uv-cache:/home/vscode/.cache/uv:z
      # Persist bash history
      - bash-history:/home/vscode/.bash_history_dir:z
    # Disable SELinux labeling (needed for Podman, ignored by Docker)
    security_opt:
      - label:disable
    environment:
      # Development environment
      - NODE_ENV=development
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      # Databricks (override in .env or mount ~/.databrickscfg)
      - DATABRICKS_HOST=${DATABRICKS_HOST:-}
      - DATABRICKS_TOKEN=${DATABRICKS_TOKEN:-}
      - DATABRICKS_WAREHOUSE=${DATABRICKS_WAREHOUSE:-}
      - DATABRICKS_PROFILE=${DATABRICKS_PROFILE:-}
      # Lakebase/PostgreSQL (optional)
      - INSTANCE_NAME=${INSTANCE_NAME:-}
    ports:
      - "3000:3000"
      - "8000:8000"
    # Use tini as PID 1 for proper signal handling
    init: true
    # Keep container running
    command: sleep infinity

# NOTE: Podman-specific settings (userns_mode: keep-id) are auto-generated
# in docker-compose.override.yml by the init script. Do not add them here
# as they cause Docker to fail.

volumes:
  vscode-extensions:
  vscode-insiders:
  pnpm-store:
  uv-cache:
  bash-history:
